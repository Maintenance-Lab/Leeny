{% extends 'layouts/base-start.html' %}

{% block title %} Borrow {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
    <div class="container-fluid d-flex justify-content-center align-items-center vh-100 gap-5">
        <div class="py-5 col-lg-4 col-md-6 col-sm-10 text-center ">
            <h3 class="mb-2">Scan your items</h3>
            <input name="barcodeInput" id="barcodeInputField" value="" onfocus="this.value=''" />
            <tr class="container px-0 w-100">
                <td class="col-7">
                    <div class="">
                      <img src="https://static.thenounproject.com/png/74445-200.png" alt="">
                    </div>
                  </td>
            </tr>
        </div>
        <div class="container-fluid align-items-center col-lg-4 col-md-6 col-sm-10 mx-0">
            <div class="card text-left">
                <div class="table-responsive p-0 " style="max-height: 450px;">
                    <table class="table align-items-center mb-0 p-3">

                    <tbody></tbody>

                    </table>
                    <div class="text-center">
                        <button type="button" class="btn btn-dark w-50 mt-2 mb-4" id="continue">Continue</button>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <a type="button" class="btn btn-outline-danger w-30 mt-2 mb-4 " href="/dashboard">Cancel</a>
            </div>
        </div>

    </div>


{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}

<script src="{{ config.ASSETS_ROOT }}/js/plugins/chartjs.min.js"></script>

<!-- Script importen die barcodes verkrijgt -->
<script src="app/apps/scripts/barcode.js"></script>

<script>
    function deleteRow(link) {
        // Find the closest row to the clicked link
        var row = link.closest('tr');
        row.remove();

        // Get the barcode of the item to be deleted
        var barcode = row.querySelector('input').getAttribute('data-barcode');
        delete addedBarcodes[barcode];
    }

    function incrementQuantity(barcode) {
         // Get the current value of the quantity input for the corresponding barcode
        var quantityInput = document.getElementById(`${barcode}`);
        var currentQuantity = addedBarcodes[barcode];
        console.log("currentQuantity: ", currentQuantity);

        // Increment the quantity
        quantityInput.value = currentQuantity + 1;
        addedBarcodes[barcode] = currentQuantity + 1;

    }

    const tableBody = document.querySelector('tbody');
    var addedBarcodes = {};

    // Function to add a new table row for an item
    function addTableRow(barcode) {
        var quantity = addedBarcodes[barcode] || 1;
        tableBody.innerHTML += `
            <tr>
                <td class="col-7">
                    <div class="d-flex px-2 py-1">
                        <div class="d-flex flex-column justify-content-center">
                            <h6 class="mb-0 text-sm text-wrap item-name">${item_name}</h6>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="col-3 input-group">
                        <input type="number" class="form-control p-1" min="1" data-barcode="${barcode}" id="${barcode}" value="${quantity}" onfocus="focused(this)" onfocusout="defocused(this)">
                    </div>
                </td>
                <td class="align-middle col-2">
                    <a href="javascript:;" class="text-secondary font-weight-bold text-xs" onclick="deleteRow(this)" data-toggle="tooltip" data-original-title="Delete item">
                        Delete
                    </a>
                </td>
            </tr>`;
    }

    var barcode = '';
    var item_name = '';
    var typingTimer;
    var doneTypingInterval = 50;

    // autofocus input field on loading page
    document.getElementById("barcodeInputField").focus();

    // autofocus input field on every click everywhere on the page
    document.addEventListener('click', function() {
        document.getElementById("barcodeInputField").focus();
    });

    // change value in dict if quantity is manually changed
    document.addEventListener('input', function(event) {
        if (event.target.tagName === 'INPUT') {
            var barcode = event.target.getAttribute('data-barcode');
            addedBarcodes[barcode] = parseInt(event.target.value);
        }
    });

    // Whenever a barcode is scanned
    document.getElementById("barcodeInputField").addEventListener('input', function() {
        // Clear the previous timer
        clearTimeout(typingTimer);

        console.log("added barcodes 1: ", addedBarcodes);

        // Get barcode from input field
        barcode = document.getElementById("barcodeInputField").value;

        // Set a new timer to handle barcode input after a certain amount of time
        typingTimer = setTimeout(function() {
            console.log("Sending this barcode: ", barcode);

            // Send the barcode to the server
            fetch('api/borrow', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ barcode: barcode })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Response from server:', data);
                item_name = data.data;

                // Check if barcode already exists on the screen
                if (barcode in addedBarcodes) {
                    // Increment quantity for existing barcode
                    incrementQuantity(barcode);
                    console.log("alleen incrementen")
                } else {
                    // Add the new barcode to the array and create a new table row
                    console.log("nieuwe barcode toevoegen: ", barcode)
                    addedBarcodes[barcode] = 1;
                    addTableRow(barcode);
                    document.getElementById(`${barcode}`).value = 1;
                }

                // var item_name = data.data;
                console.log("added barcodes 2: ", addedBarcodes);

                // Clear the input field after processing
                document.getElementById("barcodeInputField").value = "";
            })
            .catch(error => console.error('Error:', error));
        }, doneTypingInterval);
    });



</script>

{% endblock javascripts %}
