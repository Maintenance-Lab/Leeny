{% extends 'layouts/base-start.html' %}

{% block title %} Borrow {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
    <div class="container-fluid d-flex justify-content-center align-items-center vh-100 gap-5">
        <div class="py-5 col-lg-4 col-md-6 col-sm-10 text-center ">
            <h3 class="mb-2">Scan your items</h3>
            <input name="barcodeInput" id="barcodeInputField" value="" onfocus="this.value=''"  />
            <tr class="container px-0 w-100">
                <td class="col-7">
                    <div class="">
                      <img src="https://static.thenounproject.com/png/74445-200.png" alt="">
                    </div>
                  </td>
            </tr>
        </div>
        <div class="container-fluid align-items-center col-lg-4 col-md-6 col-sm-10 mx-0">
            <div class="card text-left">
                <div class="table-responsive p-0 " style="max-height: 450px;">
                    <table class="table align-items-center mb-0 p-3">

                    <tbody></tbody>

                    </table>
                    <div class="text-center">
                        <button type="button" class="btn btn-dark w-50 mt-2 mb-4" id="continue">Continue</button>
                    </div>
                </div>
            </div>
            <form method="POST" class="text-center mt-3">
                <input type='submit' value="Cancel" class="btn btn-outline-danger opacity-25 w-25 mt-2 mb-4 btn-sm">
            </form>
        </div>

    </div>


{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}

  <script src="{{ config.ASSETS_ROOT }}/js/plugins/chartjs.min.js"></script>

  <!-- Script importen die barcodes verkrijgt -->
  <script src="app/apps/scripts/barcode.js"></script>

  <script>
    function deleteRow(link) {
      // Find the closest row to the clicked link
      var row = link.closest('tr');
      row.remove();
  }

    const tableBody = document.querySelector('tbody');
    var addedBarcodes = {};

    function createElement(tag, classes = [], attributes = {}, content = '') {
        const element = document.createElement(tag);
        if (classes.length) element.classList.add(...classes);
        Object.entries(attributes).forEach(([key, value]) => element.setAttribute(key, value));
        if (content) element.textContent = content;
        return element;
    }

    function addTableRow(barcode) {
        var quantity = addedBarcodes[barcode] || 1; // Get the current quantity or default to 1

        const row = createElement('tr');
        const nameCell = createElement('td', ['col-7']);
        const nameDiv = createElement('div', ['d-flex', 'px-2', 'py-1']);
        const nameColumn = createElement('div', ['d-flex', 'flex-column', 'justify-content-center']);
        const itemName = createElement('h6', ['mb-0', 'text-sm', 'text-wrap', 'item-name'], {}, item_name);

        nameColumn.appendChild(itemName);
        nameDiv.appendChild(nameColumn);
        nameCell.appendChild(nameDiv);
        row.appendChild(nameCell);

        const quantityCell = createElement('td');
        const quantityDiv = createElement('div', ['col-3', 'input-group']);
        const quantityInput = createElement('input', ['form-control', 'p-1'], {
            type: 'number',
            min: '1',
            'data-barcode': barcode,
            id: barcode,
            value: quantity
        });
        quantityInput.addEventListener('focus', focused);
        quantityInput.addEventListener('focusout', defocused);
        quantityDiv.appendChild(quantityInput);
        quantityCell.appendChild(quantityDiv);
        row.appendChild(quantityCell);

        const deleteCell = createElement('td', ['align-middle', 'col-2']);
        const deleteLink = createElement('a', ['text-secondary', 'font-weight-bold', 'text-xs'], {
            href: 'javascript:;',
            'data-toggle': 'tooltip',
            'data-original-title': 'Delete item'
        }, 'Delete');
        deleteLink.addEventListener('click', () => deleteRow(deleteLink));
        deleteCell.appendChild(deleteLink);
        row.appendChild(deleteCell);

        tableBody.appendChild(row);

        addedBarcodes[barcode] = quantity;
    }

    var barcode = '';
    var typingTimer; // Timer identifier
    var doneTypingInterval = 50; // Time in milliseconds (1 second)

    // autofocus the input field
    document.getElementById("barcodeInputField").focus();

    document.getElementById("barcodeInputField").addEventListener('input', function() {
        console.log("barcode geregistreerd")
        // Clear the previous timer
        clearTimeout(typingTimer);
        // clear input field after sending barcode

        // Get barcode from input field
        barcode = document.getElementById("barcodeInputField").value;

        // Set a new timer to send the barcode after a certain amount of time
        typingTimer = setTimeout(function() {
            console.log("Deze barcode sturen: ", barcode);

          // Send the barcode to the server
          fetch('api/borrow', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({ barcode: barcode })
          })
          .then(response => {
              if (!response.ok) {
                  throw new Error('Response was not ok');
              }
              return response.json();
          })
          // Parse the JSON from the response
          .then(data => {
              console.log('Response from server:', data);

              // Update the HTML with the updated string received from the API
              addTableRow();

              // Adds information to table row with class item-name
              const tableRows = document.querySelectorAll('.item-name');
              const lastTableRow = tableRows[tableRows.length - 1];
              lastTableRow.innerHTML = data.data;

              // Clear the input field after processing
              document.getElementById("barcodeInputField").value = "";
          })

        . catch(error => console.error('Error:', error));

        }, doneTypingInterval);
    });








  </script>

{% endblock javascripts %}
